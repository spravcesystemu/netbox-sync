# Обновление форка netbox-sync для поддержки NetBox 4.2.x

## Контекст
- Оригинальный проект [bb-ricardo/netbox-sync] прекращает поддержку версии 1.8.x 31 октября 2025 года, поэтому мы подготовили локальный форк с минимальными правками, которые обеспечивают совместимость с NetBox 4.2.2+ и укладываются в наш регламент сопровождения.

## Ключевые технические изменения

### 1. Совместимость с объединённым полем primary IP и новыми ролями адресов
- Введён `PrimaryIPMixin`, который корректно заполняет unified-поле `primary_ip`, а также продолжает синхронизировать `primary_ip4` и `primary_ip6` для обратной совместимости с нашими интеграциями.【F:module/netbox/object_classes.py†L23-L160】
- `NBIPAddress` научился хранить информацию о том, с каким устройством или ВМ был связан адрес ранее, чтобы корректно сбрасывать флаги primary при перемещении IP между объектами.【F:module/netbox/object_classes.py†L2290-L2340】
- Добавлена поддержка новой роли `slaac`, появившейся в NetBox 4.2, чтобы валидация адресов не падала после обновления NetBox.【F:module/netbox/object_classes.py†L2290-L2309】

### 2. Учёт site groups и VLAN/Prefix scope из NetBox 4.2
- Обновлены модели сайтов, VLAN-групп и префиксов: теперь они понимают site groups и правильно сопоставляют привязку префиксов/ VLAN-групп к сайтам и кластерам, что требуется в NetBox 4.2.x.【F:module/netbox/object_classes.py†L1547-L1725】【F:module/netbox/object_classes.py†L1747-L1841】

### 3. Первичные MAC-адреса для устройств и ВМ
- Базовый источник синхронизации теперь создаёт и переиспользует `NBMACAddress`, назначая их интерфейсам и родительским устройствам/ВМ, если NetBox 4.2 и выше возвращает primary MAC API-поля.【F:module/sources/common/source_base.py†L296-L412】
- Сами NetBox-объекты устройств и ВМ получили поле `primary_mac_address`, которое очищается при удалении записи MAC, чтобы избежать «висячих» ссылок в NetBox.【F:module/netbox/object_classes.py†L2083-L2501】

### 4. Конфигурация и эксплуатация
- Парсер конфигурации добавляет явную подсказку, когда вместо файла смонтирована директория (типичная ошибка при `docker run`), и игнорирует пустые переменные окружения, чтобы не затирать значения из `settings.ini` при развёртывании в Docker/Compose.【F:module/config/parser.py†L52-L142】【F:module/config/parser.py†L250-L360】
- Версия пакета обновлена до 1.9.0 с датой релиза 21.10.2025, чтобы баннер запуска и документация отражали актуальное состояние форка.【F:module/__init__.py†L10-L14】【F:README.md†L461-L461】【F:settings-example.ini†L1-L2】

## Минимальность изменений
- Мы ограничились корректировкой существующих моделей и базовой логики импорта. Архитектура проекта, структура каталогов и точки расширения остались неизменными, что позволяет продолжать получать upstream-обновления с минимальными конфликтами.

## Рекомендации по эксплуатации
1. Использовать предоставленный образ Docker (`netbox-sync:local`) с переменной `NBS_RUN_INTERVAL=3600`, чтобы планировщик запускал синхронизацию каждый час без внешнего orchestrator'а.
2. Хранить `config/settings.ini` под контролем версий и следить за новыми полями NetBox 4.2.x (например, `site group`), которые теперь поддерживаются синхронизатором из коробки.

